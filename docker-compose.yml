services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: finmind
      POSTGRES_PASSWORD: finmind
      POSTGRES_DB: finmind
    ports: ["5432:5432"]
    volumes: ["pgdata:/var/lib/postgresql/data"]

  redis:
    image: redis:7
    ports: ["6379:6379"]

  backend:
    build: ./packages/backend
    env_file:
      - .env
    depends_on: [postgres, redis]
    ports: ["8000:8000"]
    volumes:
      - ./packages/backend/app:/app/app
      - ./packages/backend/wsgi.py:/app/wsgi.py
      - ./packages/backend/tests:/app/tests
      - ./.flake8:/app/.flake8:ro
      - ./.bandit:/app/.bandit:ro
    command: gunicorn --reload --workers=2 --threads=4 --bind 0.0.0.0:8000 wsgi:app

  frontend:
    build: ./app
    env_file:
      - .env
    ports: ["5173:80"]
    depends_on: [backend]

  # Dev-only: Vite dev server with hot reload
  frontend-dev:
    image: node:20-alpine
    working_dir: /app
    env_file:
      - .env
    environment:
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    volumes:
      - ./app:/app
      - /app/node_modules
    ports: ["5173:5173"]
    depends_on: [backend]
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 5173"
    profiles: ["dev"]

volumes:
  pgdata:
